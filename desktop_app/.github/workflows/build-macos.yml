name: Build macOS Installer

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package.json
      
      - name: Install dependencies
        working-directory: desktop_app
        run: npm install
      
      - name: Create icon
        working-directory: desktop_app
        run: |
          mkdir -p assets
          # Create a simple icon using sips (built into macOS)
          if [ ! -f assets/icon.png ]; then
            # Create a colored square as placeholder
            python3 -c "
from PIL import Image, ImageDraw
img = Image.new('RGB', (512, 512), color='#667eea')
draw = ImageDraw.Draw(img)
draw.rectangle([100, 150, 412, 362], fill='white', outline='#333', width=8)
draw.line([256, 150, 256, 362], fill='#333', width=6)
img.save('assets/icon.png')
" || echo "Icon creation skipped - will use default"
          fi
      
      - name: Convert icon to ICNS
        working-directory: desktop_app
        run: |
          if [ -f assets/icon.png ] && [ ! -f assets/icon.icns ]; then
            mkdir -p icon.iconset
            sips -z 16 16 assets/icon.png --out icon.iconset/icon_16x16.png 2>/dev/null || true
            sips -z 32 32 assets/icon.png --out icon.iconset/icon_16x16@2x.png 2>/dev/null || true
            sips -z 32 32 assets/icon.png --out icon.iconset/icon_32x32.png 2>/dev/null || true
            sips -z 64 64 assets/icon.png --out icon.iconset/icon_32x32@2x.png 2>/dev/null || true
            sips -z 128 128 assets/icon.png --out icon.iconset/icon_128x128.png 2>/dev/null || true
            sips -z 256 256 assets/icon.png --out icon.iconset/icon_128x128@2x.png 2>/dev/null || true
            sips -z 256 256 assets/icon.png --out icon.iconset/icon_256x256.png 2>/dev/null || true
            sips -z 512 512 assets/icon.png --out icon.iconset/icon_256x256@2x.png 2>/dev/null || true
            sips -z 512 512 assets/icon.png --out icon.iconset/icon_512x512.png 2>/dev/null || true
            sips -z 1024 1024 assets/icon.png --out icon.iconset/icon_512x512@2x.png 2>/dev/null || true
            iconutil -c icns icon.iconset -o assets/icon.icns 2>/dev/null || true
            rm -rf icon.iconset
          fi
      
      - name: Build macOS app
        working-directory: desktop_app
        run: npm run build:mac
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v3
        with:
          name: Proverbs-Book-AI-macOS-Installer
          path: desktop_app/dist/*.dmg
          retention-days: 30
      
      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: desktop_app/dist/*.dmg
          draft: false
          prerelease: false
