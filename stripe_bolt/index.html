<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wilhelm Software — Checkout</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0b0b12; color: #f5f5ff; }
    header { padding: 24px; text-align: center; background: linear-gradient(135deg, #6a5acd, #6b46c1); }
    header h1 { font-size: 26px; margin-bottom: 6px; }
    .container { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
    .card { background: #12121a; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
    .card h3 { font-size: 18px; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; background: #2d2d44; }
    .price { font-size: 18px; font-weight: 700; }
    .actions { display: flex; gap: 8px; }
    .actions button { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .buy { background: #4a90e2; color: #fff; }
    .add { background: #6a5acd; color: #fff; }
    .panel { background: #101018; border: 1px solid rgba(255,255,255,0.08); padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    .panel input, .panel select, .panel textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #2c2c3a; background: #151522; color: #fff; margin-top: 8px; margin-bottom: 12px; }
    .panel button { background: #6a5acd; color: #fff; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .cart-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .muted { opacity: 0.7; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>Wilhelm Software Checkout</h1>
    <p>Buy now or add to cart for any solution</p>
  </header>

  <div class="container">
    <div class="panel">
      <h3>Admin — Add Product</h3>
      <input id="adminKey" placeholder="Admin Key (set below)" />
      <input id="title" placeholder="Product Title" />
      <textarea id="description" placeholder="Description"></textarea>
      <input id="category" placeholder="Category" />
      <input id="price" placeholder="Price (e.g., 149)" />
      <select id="billing">
        <option value="payment">One-time</option>
        <option value="subscription">Subscription</option>
      </select>
      <select id="interval">
        <option value="month">Monthly</option>
        <option value="year">Yearly</option>
      </select>
      <button onclick="saveProduct()">Save Product</button>
      <div class="muted">Admin key is client-side only. For full security, move admin to backend.</div>
    </div>

    <div class="panel">
      <h3>Products</h3>
      <div class="grid" id="productGrid"></div>
    </div>

    <div class="panel">
      <h3>Cart</h3>
      <div id="cartList"></div>
      <button onclick="checkoutCart()">Checkout Cart</button>
      <div class="muted">Cart supports one billing type per checkout.</div>
    </div>
  </div>

  <script>
    const ADMIN_UI_KEY = 'change-me';
    const PRODUCTS_KEY = 'wtcStoreProducts';
    const CART_KEY = 'wtcStoreCart';

    async function loadSeed() {
      const existing = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || '[]');
      if (existing.length > 0) return render();
      try {
        const res = await fetch('mcp.json', { cache: 'no-store' });
        const data = await res.json();
        const products = data.map((item) => ({
          id: item.id || Date.now(),
          title: item.title || 'Product',
          description: item.description || '',
          category: item.category || '',
          price: item.price || '',
          billing: item.billing === 'subscription' ? 'subscription' : 'payment',
          interval: item.interval || 'month'
        }));
        localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
      } catch {
        localStorage.setItem(PRODUCTS_KEY, JSON.stringify([]));
      }
      render();
    }

    function saveProduct() {
      const key = document.getElementById('adminKey').value.trim();
      if (key !== ADMIN_UI_KEY) return alert('Invalid admin key');
      const product = {
        id: Date.now(),
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        category: document.getElementById('category').value.trim(),
        price: document.getElementById('price').value.trim(),
        billing: document.getElementById('billing').value,
        interval: document.getElementById('interval').value
      };
      if (!product.title || !product.price) return alert('Title and price required');
      const products = getProducts();
      products.push(product);
      localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
      clearForm();
      render();
    }

    function addToCart(id) {
      const cart = getCart();
      cart.push({ id, quantity: 1 });
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      render();
    }

    function buyNow(id) {
      const product = getProducts().find(p => p.id === id);
      if (!product) return;
      checkout([product], product.billing);
    }

    function checkoutCart() {
      const cart = getCart();
      if (!cart.length) return alert('Cart is empty');
      const products = getProducts();
      const items = cart.map(c => ({ ...products.find(x => x.id === c.id), quantity: c.quantity })).filter(Boolean);
      const billing = items[0].billing;
      if (items.some(i => i.billing !== billing)) return alert('Mixed billing types not allowed in one checkout.');
      checkout(items, billing);
    }

    async function checkout(items, billing) {
      const response = await fetch('/api/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items, mode: billing })
      });
      const data = await response.json();
      if (data.url) window.location = data.url;
      else alert(data.error || 'Checkout failed');
    }

    function getProducts() { return JSON.parse(localStorage.getItem(PRODUCTS_KEY) || '[]'); }
    function getCart() { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }

    function removeFromCart(id) {
      const cart = getCart().filter(c => c.id !== id);
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      render();
    }

    function render() {
      const products = getProducts();
      document.getElementById('productGrid').innerHTML = products.map(p => `
        <div class="card">
          <div class="badge">${p.category || 'Software'}</div>
          <h3>${p.title}</h3>
          <p>${p.description || ''}</p>
          <div class="price">$${p.price} ${p.billing === 'subscription' ? '/ ' + p.interval : ''}</div>
          <div class="actions">
            <button class="add" onclick="addToCart(${p.id})">Add to Cart</button>
            <button class="buy" onclick="buyNow(${p.id})">Buy Now</button>
          </div>
        </div>
      `).join('') || '<p>No products yet.</p>';

      const cart = getCart();
      document.getElementById('cartList').innerHTML = cart.map(c => {
        const p = products.find(x => x.id === c.id) || {};
        return `<div class="cart-item">
          <span>${p.title || 'Unknown'} ($${p.price || '-'})</span>
          <button onclick="removeFromCart(${c.id})">Remove</button>
        </div>`;
      }).join('') || '<p class="muted">Cart is empty</p>';
    }

    function clearForm() {
      ['title','description','category','price'].forEach(id => document.getElementById(id).value = '');
    }

    loadSeed();
  </script>
</body>
</html>
